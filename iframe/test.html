<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      iframe {
        height: 0; /* Most important rule, sets iframe to 0 height. */
        padding-left: 7%; /* To better align the content in the frame. */

        opacity: 1; /* Transition between loading states. */
        transition: opacity 1s ease-in-out;

        border: 1px solid red; /* DEBUG to see the frame. */
      }
      iframe.loading {
        opacity: 0;
        transition: opacity 300ms ease-in-out;
      }
      .iframeFrame {
        /* Keep the content centered and sized */
        display: grid;
        grid-template-columns: minmax(200px, 90ch);
        justify-content: space-around;
        justify-items: stretch;

        overflow: hidden; /* Keep the frame inside its frame. */

        border: 1px dashed green; /* DEBUG: to see the frame. */
        transition: height 1s ease-in-out; /* Slow down the transition to see what's happening. */
      }
    </style>
  </head>
  <body>
    <button>Load a page</button>
    <span class="currentHeight"></span>
    <div class="iframeFrame">
      <iframe
        id="contentIFrame"
        scrolling="no"
        frameborder="0"
        referrerpolicy="noreferrer"
        title="Content window"
      ></iframe>
    </div>
    <button>Load a page</button>
    <span class="currentHeight"></span>
    <script>
      (function (d) {
        // Targets iterator (infinite sequence)
        const targets = (function* () {
          const pages = [
            "https://support.office.com/en-us/client/5bec897f-4e36-43f8-9d9d-c41cb4917d9c?embed=true",
            "https://support.office.com/en-us/client/92d238e6-0ae2-447e-af90-40b1052c4547?embed=true",
            "https://support.office.com/en-us/client/741bf760-39fc-4807-ad8b-92558273f542?embed=true",
            "https://support.office.com/en-us/client/get-your-team-up-and-running-702a2977-e662-4038-bef5-bdf8ee47b17b?embed=true",
            "https://support.microsoft.com/en-us/office/share-and-collaborate-with-onedrive-51e669f6-4602-4492-8648-13ffa09ff24f?ui=en-US&rs=en-US&ad=US",
          ];
          let index = 0;
          while (true) {
            yield pages[index++];
            if (index === pages.length) index = 0;
          }
        })();

        const CLIENT_MSG = "help_getClientHeight";
        const MAX_HEIGHT = "1950px"; // Should be bigger...
        const LOADING_CLASS = "loading";

        /** @type HTMLIFrameElement */
        const iframe = d.getElementById("contentIFrame");
        /** @type HTMLDivElement */
        const iframeFrame = d.querySelector(".iframeFrame");

        /**
         * Smooth scroller.
         * TODO: Bring the element fully on screen.
         * @param {HTMLElement} el
         */
        const scrollTo = (el) => {
          var to = el ? el.offsetTop : 0;
          var from = window.pageYOffset;
          var isVisible =
            to > from
              ? /** @param {number} offset */
                (offset) => offset < to
              : (offset) => offset > to;
          const interval = window.setInterval(() => {
            var pos = window.pageYOffset;
            if (visible(pos)) {
              window.scrollTo(0, pos - 20); // how far to scroll on each step
            } else {
              window.clearInterval(interval);
            }
          }, 16);
        };

        // Track back button events.
        window.addEventListener(
          "popstate",
          /** @param {PopStateEvent} e */
          (e) => {
            console.log(e, e.state);
            if (e.state) {
              setSize(e.state.iframeHeight, e.state.autoSize);
              currentUrl = new URL(e.state.url);

              if (currentUrl != iframe.src) {
                console.error("*** iframe out of sync with history! ***");
              }
            }
          }
        );

        iframe.addEventListener("unload", (e) => {
          console.log("iframe unload", e);
        });

        // React to message by setting iframe height.
        window.addEventListener(
          "message",
          /** @param {MessageEvent} e */ (e) => {
            if (e.data.indexOf(CLIENT_MSG) == 0) {
              const height = `${e.data.split("=")[1]}px`;
              setSize(height);
            } else {
              setSize(MAX_HEIGHT);
            }
          }
        );

        let autoSize = false;
        let currentUrl;

        const postMessage = () => {
          if (autoSize) {
            try {
              // Set height when user clicks link inside iframe.
              if (!iframe.classList.contains(LOADING_CLASS)) {
                iframe.style.height = "";
              }
              iframe.contentWindow.postMessage(CLIENT_MSG, currentUrl.origin);
            } catch (ex) {
              setSize(MAX_HEIGHT);
            }
          } else {
            setSize(MAX_HEIGHT);
          }
        };

        /**
         * @param {URL} url
         */
        const shouldSize = (url) => {
          return !!(
            url.host === "support.office.com" &&
            url.search.indexOf("embed=true") > 0
          );
        };

        /**
         * @param {string} size
         */
        const setSize = (size, scrollbar) => {
          if (size && iframe.style.height != size) {
            iframe.style.height = size;
            iframeFrame.style.height = size;
            iframe.scrolling = scrollbar ? "no" : "yes";
            window.scrollTo();
          }

          iframe.classList.remove(LOADING_CLASS);

          // // Push state for current page
          // const newState = {
          //   ...history.state,
          //   iframeHeight: size,
          //   autoSize,
          //   url: currentUrl.href,
          // };
          // if (history.state) {
          //   if (JSON.stringify(history.state) != JSON.stringify(newState)) {
          //     console.log("PUSH STATE", newState);
          //     history.pushState(newState, "");
          //   }
          //   else {
          //     console.log("SAME STATE");
          //   }
          // } else {
          //   console.log("REPLACE STATE", newState);
          //   history.replaceState(newState, "");
          // }

          // Report height
          [...d.getElementsByClassName("currentHeight")].forEach(
            (el) => (el.textContent = size)
          );
        };

        // Post size message as soon as possible after loading.
        iframe.addEventListener("load", (e) => {
          console.log("iframe loaded", e);
          postMessage();
        });

        /**
         * Request a new page.
         * @param {string} url
         */
        const loadIframe = (url) => {
          iframe.classList.add(LOADING_CLASS);
          currentUrl = new URL(url);
          autoSize = shouldSize(currentUrl);
          // NOTE: Must set iframe back to 0 height for accurate results.
          iframe.style.height = "";
          iframe.src = currentUrl.href;
        };

        // Trigger page load via button.
        d.querySelectorAll("button").forEach((btn) =>
          btn.addEventListener("click", () => loadIframe(targets.next().value))
        );

        loadIframe(targets.next().value);
      })(document);
    </script>
  </body>
</html>
