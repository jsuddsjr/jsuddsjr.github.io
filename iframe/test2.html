<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resize IFRAME test</title>
    <style>
      iframe {
        padding-left: 7%; /* To better align the content in the frame. */
        opacity: 1; /* Transition between loading states. */
        transition: opacity 1s ease-in-out;
        border: 1px solid red; /* DEBUG to see the frame. */
      }
      iframe.loading {
        opacity: 0;
        transition: opacity 300ms ease-in-out;
      }
      .iframeFrame {
        /* Keep the content centered and sized */
        display: grid;
        grid-template-columns: minmax(200px, 90ch);
        justify-content: space-around;
        justify-items: stretch;

        -overflow: hidden; /* Keep the frame inside its frame. */

        border: 1px dashed green; /* DEBUG: to see the frame. */
        transition: height 1s ease-in-out; /* Slow down the transition to see what's happening. */
      }
    </style>
  </head>
  <body>
    <button>Load a page</button>
    <span class="currentHeight"></span>
    (<span class="mouseLocation"></span>)
    <div class="iframeFrame">
      <iframe
        id="contentIFrame"
        scrolling="no"
        frameborder="0"
        referrerpolicy="noreferrer"
        title="Content window"
        height="0"
      ></iframe>
    </div>
    <button>Load a page</button>
    <span class="currentHeight"></span>
    <script>
      (function (d) {
        // Only send size messages to these domains. All others will load into average-sized iframe with scrollbars.
        const allowedDomains = ["support.office.com", "support.microsoft.com"];

        // Test data (infinite sequence)
        const targets = (function* () {
          const pages = [
            "https://support.office.com/en-us/client/5bec897f-4e36-43f8-9d9d-c41cb4917d9c?embed=true",
            "https://support.office.com/en-us/client/92d238e6-0ae2-447e-af90-40b1052c4547?embed=true",
            "https://support.office.com/en-us/client/741bf760-39fc-4807-ad8b-92558273f542?embed=true",
            "https://support.office.com/en-us/client/get-your-team-up-and-running-702a2977-e662-4038-bef5-bdf8ee47b17b?embed=true",
            "https://support.microsoft.com/en-us/office/share-and-collaborate-with-onedrive-51e669f6-4602-4492-8648-13ffa09ff24f?ui=en-US&rs=en-US&ad=US",
          ];
          let index = 0;
          while (true) {
            yield pages[index++];
            if (index === pages.length) index = 0;
          }
        })();

        const CLIENT_MSG = "help_getClientHeight";
        const AVG_HEIGHT = "2500px"; // Should it be bigger?
        const LOADING_CLASS = "loading";

        /** @type HTMLIFrameElement */
        const iframe = d.getElementById("contentIFrame");
        /** @type HTMLDivElement */
        const iframeFrame = d.querySelector("div.iframeFrame");

        /**
         * Send cross-origin message to get content height.
         * @param {string} src
         */
        const postMessage = (src) => {
          if (src) {
            try {
              const url = new URL(src);
              if (
                allowedDomains.includes(url.host) ||
                url.search.indexOf("embed=true") > 0
              ) {
                iframe.contentWindow.postMessage(CLIENT_MSG, url.origin);
                return true;
              }
            } catch (ex) {}
          }
          return false;
        };

        // React to message by setting iframe height.
        window.addEventListener(
          "message",
          /** @param {MessageEvent} e */ (e) => {
            if (e.data.indexOf(CLIENT_MSG) == 0) {
              const height = `${e.data.split("=")[1]}px`;
              setHeight(height, false);
            } else {
              setHeight(AVG_HEIGHT);
            }
          },
          true
        );

        // Post size message as soon as possible after loading.
        iframe.addEventListener(
          "load",
          () => {
            if (iframe.src) {
              postMessage(iframe.src) || setHeight(AVG_HEIGHT);
            }
          },
          true
        );

        let mouseOverIframe = false;
        iframe.addEventListener(
          "mouseenter",
          () => (mouseOverIframe = true),
          true
        );
        iframe.addEventListener(
          "mouseover",
          () => (mouseOverIframe = true),
          true
        );
        iframe.addEventListener(
          "mouseleave",
          () => (mouseOverIframe = false),
          true
        );
        iframe.addEventListener(
          "mouseout",
          () => (mouseOverIframe = false),
          true
        );
        iframe.addEventListener("click", () => console.log("iframe clicked"));
        window.addEventListener(
          "mousemove",
          /** @param {MouseEvent} e */ (e) =>
            [...document.getElementsByClassName("mouseLocation")].forEach(
              (el) =>
                (el.textContent = `${e.clientX},${e.clientY} - ${mouseOverIframe}`)
            ), true
        );
        window.addEventListener("blur", () => {
          if (mouseOverIframe) postMessage(iframe.src);
        }, true);

        let debounceResize;
        window.addEventListener(
          "resize",
          () => {
            clearInterval(debounceResize);
            debounceResize = setTimeout(postMessage, 400);
          },
          true
        );

        /**
         * Set the iframe height.
         * @param {string} height
         */
        const setHeight = (height, scrollbar = true) => {
          // If the height is set to the current value
          if (!scrollbar && height === iframe.height) {
            iframe.height = `${Math.max(Number(iframe.height) - 1000, 0)}px`;
            setTimeout(() => postMessage(iframe.src), 10);
          } else if (iframe.height !== height) {
            iframe.height = height;
            iframeFrame.style.height = height;
          }

          iframe.scrolling = scrollbar ? "yes" : "no";
          iframe.classList.remove(LOADING_CLASS);

          // TODO: Remove.
          [...d.getElementsByClassName("currentHeight")].forEach(
            (el) => (el.textContent = height)
          );
        };

        /**
         * Request a new page.
         * @param {string} target
         */
        let debounceLoad;
        const loadIframe = (target) => {
          console.log("Loading", target);
          iframe.classList.add(LOADING_CLASS);

          // Just in case loading gets hung up somewhere...
          clearInterval(debounceLoad);
          debounceLoad = setTimeout(() => {
            if (iframe.classList.contains(LOADING_CLASS)) {
              setHeight(AVG_HEIGHT);
              iframe.classList.remove(LOADING_CLASS);
            }
          }, 4000);

          iframe.src = target;
        };

        // Trigger page load via button.
        d.querySelectorAll("button").forEach((btn) =>
          btn.addEventListener("click", () => loadIframe(targets.next().value))
        );
      })(document);
    </script>
  </body>
</html>
